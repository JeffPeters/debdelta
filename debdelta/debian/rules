#!/usr/bin/make -f
# Sample debian/rules file; from GNU Hello,  Copyright 1994,1995 by Ian Jackson.

package = debdelta

D = debian/tmp

docdir = $(D)/usr/share/doc/$(package)
mandir = $(D)/usr/share/man/man1/

CC = gcc
CFLAGS = -g -Wall
INSTALL_PROGRAM = install

ifeq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
  CFLAGS += -O2
endif
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
  INSTALL_PROGRAM += -s
endif


minibzip2: minigzip.c
	$(CC) -DBZIP $(CFLAGS) -lbz2  minigzip.c -o minibzip2 

build: minibzip2
	$(checkdir)
	$(MAKE) CC="$(CC)" CFLAGS="$(CFLAGS)" LDFLAGS="-lz" minigzip
	touch build

clean:
	$(checkdir)
	rm -f build *~ */*~ debian/files* debian/substvars
	rm -f minigzip minibzip2
	rm -rf $(D)

binary-indep:	checkroot build
	$(checkdir)
# There are no architecture-independent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

binary-arch:	checkroot build
	$(checkdir)
	rm -rf $(D)
	# dirs
	install -d $(D)/DEBIAN $(D)/usr/bin $(docdir) $(mandir) $(D)/usr/lib/debdelta $(D)/usr/share/debdelta
	install -m 755 debian/postrm $(D)/DEBIAN/
	# /usr/share
	install contrib/debmirror-delta-security $(D)/usr/share/debdelta
	install contrib/debmirror-20051209_--trash_option.patch  $(D)/usr/share/debdelta
	# /usr/lib
	$(INSTALL_PROGRAM)  minigzip $(D)/usr/lib/debdelta/minigzip
	$(INSTALL_PROGRAM)  minibzip2 $(D)/usr/lib/debdelta/minibzip2
	# /etc
	install -d $(D)/etc/debdelta
	cp etc/sources.conf $(D)/etc/debdelta/sources.conf
	# /usr/bin
	cp  debdelta $(D)/usr/bin/debdelta
	echo /etc/debdelta/sources.conf >> $(D)/DEBIAN/conffiles
	chmod +x  $(D)/usr/bin/debdelta
	ln -s debdelta  $(D)/usr/bin/debpatch
	ln -s ../../bin/debdelta  $(D)/usr/share/debdelta/debpatch-url
	ln -s debdelta  $(D)/usr/bin/debdeltas
	ln -s debdelta  $(D)/usr/bin/debdelta-upgrade
	# /usr/share/doc
	cp FAQ README README.upgrade debian/copyright debian/changelog $(docdir)
	cd $(docdir) && gzip -9 changelog README README.upgrade FAQ
	# man
	cp *.1 $(mandir)
	gzip -9 $(mandir)/*.1 
	# build package
	dpkg-shlibdeps $(D)/usr/lib/debdelta/minigzip  $(D)/usr/lib/debdelta/minibzip2
	dpkg-gencontrol -isp
	chown -R root:root $(D)
	chmod -R u+w,go=rX $(D)
	dpkg-deb -Zlzma --build $(D) ..

define checkdir
	test -f debdelta -a -f debian/rules
endef

binary: binary-indep binary-arch

checkroot:
	$(checkdir)
	test $$(id -u) = 0

.PHONY: binary binary-arch binary-indep clean checkroot
